generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  createdAt DateTime @default(now())
}

model Party {
  id                String         @id @default(uuid())
  name              String
  address           String?
  gstNumber         String?
  drugLicenseNumber String?
  notes             String?
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  emails            Email[]
  phones            Phone[]
  PurchaseBills     PurchaseBill[]
}

model Phone {
  id      String @id @default(uuid())
  phone   String
  partyId String
  party   Party  @relation(fields: [partyId], references: [id])
}

model Email {
  id      String @id @default(uuid())
  email   String
  partyId String
  party   Party  @relation(fields: [partyId], references: [id])
}

model Product {
  id            String         @id @default(uuid())
  name          String
  manufacturer  String?
  hsn           String?
  pack          String?
  mrp           Float?
  gstPercent    Float?
  isActive      Boolean        @default(true)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  PurchaseItems PurchaseItem[]
}

model PurchaseBill {
  id          String         @id @default(uuid())
  invoiceNo   String?
  invoiceDate DateTime?
  partyId     String
  totalAmount Float?
  createdAt   DateTime       @default(now())
  party       Party          @relation(fields: [partyId], references: [id])
  items       PurchaseItem[]
}

model PurchaseItem {
  id         String       @id @default(uuid())
  productId  String
  purchaseId String
  batch      String?
  expiry     String?
  quantity   Int
  rate       Float
  discount   Float?
  gstPercent Float?
  mrp        Float?
  product    Product      @relation(fields: [productId], references: [id])
  purchase   PurchaseBill @relation(fields: [purchaseId], references: [id])
}

model OrderInitiation {
  id              String      @id @default(uuid())
  source          OrderSource
  filledByUserId  String?
  clientFormToken String?

  fullName   String
  address    String
  city       String
  state      String
  postalCode String
  country    String
  email      String
  phone      String

  remitterName String
  amountPaid   Decimal @db.Decimal(12, 2)
  currency     String

  status OrderStatus @default(INITIATED)

  // ✅ opposite side of 1-1
  clientFormLink ClientFormLink?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([email])
}

model ClientFormLink {
  id          String    @id @default(uuid())
  token       String    @unique
  isUsed      Boolean   @default(false)
  expiresAt   DateTime
  createdById String?
  usedAt      DateTime?

  // ✅ 1-1 link
  orderId String?          @unique
  order   OrderInitiation? @relation(fields: [orderId], references: [id])

  createdAt DateTime @default(now())

  @@index([isUsed])
  @@index([expiresAt])
}

enum OrderSource {
  CLIENT
  SALES
}

enum OrderStatus {
  INITIATED
  SALES_UPDATED
  PAYMENT_VERIFIED
  PACKING
  DISPATCHED
}
