generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  MANAGER
  SALES
  ACCOUNTS
  PACKAGING
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  name      String
  role      Role     @default(SALES)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Party {
  id                String         @id @default(uuid())
  name              String
  address           String?
  gstNumber         String?
  drugLicenseNumber String?
  notes             String?
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  emails            Email[]
  phones            Phone[]
  PurchaseBills     PurchaseBill[]
}

model Phone {
  id      String @id @default(uuid())
  phone   String
  partyId String
  party   Party  @relation(fields: [partyId], references: [id])
}

model Email {
  id      String @id @default(uuid())
  email   String
  partyId String
  party   Party  @relation(fields: [partyId], references: [id])
}

model Product {
  id            String           @id @default(uuid())
  name          String
  manufacturer  String?
  hsn           String?
  pack          String?
  mrp           Float?
  gstPercent    Float?
  isActive      Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  PurchaseItems PurchaseItem[]
  orderItems    OrderEntryItem[]
}

model PurchaseBill {
  id          String         @id @default(uuid())
  invoiceNo   String?
  invoiceDate DateTime?
  partyId     String
  totalAmount Float?
  createdAt   DateTime       @default(now())
  party       Party          @relation(fields: [partyId], references: [id])
  items       PurchaseItem[]
}

model PurchaseItem {
  id         String       @id @default(uuid())
  productId  String
  purchaseId String
  batch      String?
  expiry     String?
  quantity   Int
  rate       Float
  discount   Float?
  gstPercent Float?
  mrp        Float?
  product    Product      @relation(fields: [productId], references: [id])
  purchase   PurchaseBill @relation(fields: [purchaseId], references: [id])
}

model OrderInitiation {
  id              String      @id @default(uuid())
  source          OrderSource
  filledByUserId  String?
  clientFormToken String?
  fullName        String
  address         String
  city            String
  state           String
  postalCode      String
  country         String
  email           String
  phone           String
  remitterName    String
  amountPaid      Decimal     @db.Decimal(12, 2)
  currency        String
  status          OrderStatus @default(INITIATED)
  orderValue      Decimal?    @db.Decimal(12, 2)
  clientFormLink  ClientFormLink?
  orderEntry      OrderEntry?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  accountId       String?
  account         ClientAccount? @relation(fields: [accountId], references: [id])

  @@index([status])
  @@index([email])
  @@index([accountId])
}

model ClientFormLink {
  id          String    @id @default(uuid())
  token       String    @unique
  isUsed      Boolean   @default(false)
  expiresAt   DateTime
  createdById String?
  usedAt      DateTime?
  orderId     String?   @unique
  order       OrderInitiation? @relation(fields: [orderId], references: [id])
  createdAt   DateTime  @default(now())

  @@index([isUsed])
  @@index([expiresAt])
}

enum OrderSource {
  CLIENT
  SALES
}

enum OrderStatus {
  INITIATED
  SALES_UPDATED
  PAYMENT_VERIFIED
  PACKING
  DISPATCHED
}

enum ShipmentMode {
  EMS
  ITPS
  RMS
  DHL
}

model OrderEntry {
  id            String          @id @default(uuid())
  orderId       String          @unique
  order         OrderInitiation @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shippingPrice Decimal         @db.Decimal(12, 2)
  shipmentMode  ShipmentMode
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  items         OrderEntryItem[]
}

model OrderEntryItem {
  id           String     @id @default(uuid())
  orderEntryId String
  orderEntry   OrderEntry @relation(fields: [orderEntryId], references: [id], onDelete: Cascade)
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  quantity     Int
  sellingPrice Decimal    @db.Decimal(12, 2)
  createdAt    DateTime   @default(now())

  @@index([orderEntryId])
  @@index([productId])
}

model ClientAccount {
  id             String              @id @default(uuid())
  name           String
  balance        Decimal             @db.Decimal(12, 2) @default(0)
  googleSheetId  String?
  googleSheetUrl String?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  links          ClientAccountLink[]
  orders         OrderInitiation[]
  ledger         AccountLedger[]
}

model ClientAccountLink {
  id        String        @id @default(uuid())
  token     String        @unique
  accountId String
  account   ClientAccount @relation(fields: [accountId], references: [id])
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())

  @@index([accountId])
}

enum LedgerType {
  CREDIT
  DEBIT
}

model AccountLedger {
  id        String        @id @default(uuid())
  accountId String
  account   ClientAccount @relation(fields: [accountId], references: [id])
  type      LedgerType
  amount    Decimal       @db.Decimal(12, 2)
  note      String?
  orderId   String?
  createdAt DateTime      @default(now())

  @@index([accountId])
  @@index([orderId])
}
