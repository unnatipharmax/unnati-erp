generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  MANAGER
  SALES
  ACCOUNTS
  PACKAGING
}

model User {
  id        String   @id @default(uuid())
  username  String   @unique
  email     String   @unique
  password  String
  name      String
  role      Role     @default(SALES)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Party {
  id                String         @id @default(uuid())
  name              String
  address           String?
  gstNumber         String?
  drugLicenseNumber String?
  notes             String?
  isActive          Boolean        @default(true)
  createdAt         DateTime       @default(now())
  updatedAt         DateTime       @updatedAt
  emails            Email[]
  phones            Phone[]
  PurchaseBills     PurchaseBill[]
}

model Phone {
  id      String @id @default(uuid())
  phone   String
  partyId String
  party   Party  @relation(fields: [partyId], references: [id])
}

model Email {
  id      String @id @default(uuid())
  email   String
  partyId String
  party   Party  @relation(fields: [partyId], references: [id])
}

model Product {
  id           String  @id @default(uuid())
  name         String
  manufacturer String?
  hsn          String?
  pack         String?
  mrp          Float?
  gstPercent   Float?
  // ── New fields ──────────────────────────────
  composition  String?   // e.g. "LEVONORGESTREL TAB 1.5"
  batchNo      String?   // e.g. "DH250092B"
  mfgDate      String?   // stored as string e.g. "Jul-25"
  expDate      String?   // stored as string e.g. "Jun-27"
  // ────────────────────────────────────────────
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  PurchaseItems PurchaseItem[]
  orderItems    OrderEntryItem[]
}

model PurchaseBill {
  id          String         @id @default(uuid())
  invoiceNo   String?
  invoiceDate DateTime?
  partyId     String
  totalAmount Float?
  createdAt   DateTime       @default(now())
  party       Party          @relation(fields: [partyId], references: [id])
  items       PurchaseItem[]
}

model PurchaseItem {
  id            String       @id @default(uuid())
  productId     String
  purchaseId    String
  batch         String?
  expiry        String?
  quantity      Int
  rate          Float        // purchase rate — INR unit = rate * 1.15
  discount      Float?
  // GST breakdown — stored separately for CA/accounting purposes
  gstPercent    Float?       // total GST % e.g. 5 or 18
  cgstPercent   Float?       // CGST % e.g. 2.5 or 9
  sgstPercent   Float?       // SGST % e.g. 2.5 or 9
  igstPercent   Float?       // IGST % if interstate (= gstPercent)
  taxableAmount Float?       // taxable value before GST
  cgstAmount    Float?       // actual CGST rupee amount from bill
  sgstAmount    Float?       // actual SGST rupee amount from bill
  igstAmount    Float?       // actual IGST rupee amount from bill
  mrp           Float?
  product       Product      @relation(fields: [productId], references: [id])
  purchase      PurchaseBill @relation(fields: [purchaseId], references: [id])
}

// ── Invoice sequence counter ───────────────────────────────────────────────
// One row per financial year e.g. "2526" → last used sequence number
model InvoiceSequence {
  id           String @id @default(uuid())
  financialYear String @unique  // e.g. "2526" for FY 2025-26
  lastNumber   Int    @default(0)
}

model OrderInitiation {
  id              String      @id @default(uuid())
  source          OrderSource
  filledByUserId  String?
  clientFormToken String?
  fullName        String
  address         String
  city            String
  state           String
  postalCode      String
  country         String
  email           String
  phone           String
  remitterName    String
  amountPaid      Decimal     @db.Decimal(12, 2)
  currency        String
  status          OrderStatus @default(INITIATED)
  orderValue      Decimal?    @db.Decimal(12, 2)

  // ── Accounts / Payment fields ──────────────────────────────────────────
  inrAmount          Decimal?  @db.Decimal(12, 2)
  dollarAmount       Decimal?  @db.Decimal(12, 2)
  paymentDepositDate DateTime?
  grsNumber          String?
  exchangeRate       Decimal?  @db.Decimal(10, 4)

  // ── Invoice fields (set when packaging generates invoice) ──────────────
  invoiceNo          String?   @unique  // e.g. "E-2526-001"
  invoiceGeneratedAt DateTime?

  clientFormLink  ClientFormLink?
  orderEntry      OrderEntry?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  accountId       String?
  account         ClientAccount? @relation(fields: [accountId], references: [id])

  @@index([status])
  @@index([email])
  @@index([accountId])
  @@index([invoiceNo])
}

model ClientFormLink {
  id          String           @id @default(uuid())
  token       String           @unique
  isUsed      Boolean          @default(false)
  expiresAt   DateTime
  createdById String?
  usedAt      DateTime?
  orderId     String?          @unique
  order       OrderInitiation? @relation(fields: [orderId], references: [id])
  createdAt   DateTime         @default(now())

  @@index([isUsed])
  @@index([expiresAt])
}

enum OrderSource {
  CLIENT
  SALES
}

enum OrderStatus {
  INITIATED
  SALES_UPDATED
  PAYMENT_VERIFIED
  PACKING
  DISPATCHED
}

enum ShipmentMode {
  EMS
  ITPS
  RMS
  DHL
}

model OrderEntry {
  id            String          @id @default(uuid())
  orderId       String          @unique
  order         OrderInitiation @relation(fields: [orderId], references: [id], onDelete: Cascade)
  shippingPrice Decimal         @db.Decimal(12, 2)
  shipmentMode  ShipmentMode
  notes         String?
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt
  items         OrderEntryItem[]
}

model OrderEntryItem {
  id           String     @id @default(uuid())
  orderEntryId String
  orderEntry   OrderEntry @relation(fields: [orderEntryId], references: [id], onDelete: Cascade)
  productId    String
  product      Product    @relation(fields: [productId], references: [id])
  quantity     Int
  sellingPrice Decimal    @db.Decimal(12, 2)
  createdAt    DateTime   @default(now())

  @@index([orderEntryId])
  @@index([productId])
}

model ClientAccount {
  id             String              @id @default(uuid())
  name           String
  balance        Decimal             @db.Decimal(12, 2) @default(0)
  googleSheetId  String?
  googleSheetUrl String?
  isActive       Boolean             @default(true)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime            @updatedAt
  links          ClientAccountLink[]
  orders         OrderInitiation[]
  ledger         AccountLedger[]
}

model ClientAccountLink {
  id        String        @id @default(uuid())
  token     String        @unique
  accountId String
  account   ClientAccount @relation(fields: [accountId], references: [id])
  isActive  Boolean       @default(true)
  createdAt DateTime      @default(now())

  @@index([accountId])
}

enum LedgerType {
  CREDIT
  DEBIT
}

model AccountLedger {
  id        String        @id @default(uuid())
  accountId String
  account   ClientAccount @relation(fields: [accountId], references: [id])
  type      LedgerType
  amount    Decimal       @db.Decimal(12, 2)
  note      String?
  orderId   String?
  createdAt DateTime      @default(now())

  @@index([accountId])
  @@index([orderId])
}
